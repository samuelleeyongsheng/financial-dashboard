import yfinance as yf
import sqlite3
from datetime import datetime

# 1. Define the Assets we want to track
TICKERS = ["BTC-USD", "TSLA", "NVDA", "GOOGL"]

#Initialize the database
def init_db():
    conn = sqlite3.connect('news.db')
    c = conn.cursor()
    # We added a 'ticker' column to know which stock the news is about
    c.execute('''CREATE TABLE IF NOT EXISTS news
                 (id INTEGER PRIMARY KEY, 
                  ticker TEXT, 
                  title TEXT, 
                  link TEXT UNIQUE, 
                  publisher TEXT, 
                  published INTEGER)''')
    conn.commit()
    conn.close()

def save_news(ticker, news_item):
    conn = sqlite3.connect('news.db')
    c = conn.cursor()
    try:
        # yfinance gives us a timestamp (providerPublishTime), title, link, and publisher
        c.execute('''INSERT INTO news (ticker, title, link, publisher, published) 
                     VALUES (?, ?, ?, ?, ?)''',
                  (ticker, 
                   news_item['title'], 
                   news_item['link'], 
                   news_item['publisher'], 
                   news_item['providerPublishTime']))
        return True # Saved successfully
    except sqlite3.IntegrityError:
        return False # Duplicate article
    finally:
        conn.commit()
        conn.close()

def fetch_market_news():
    print(f"--- ðŸš€ Starting Scraper for: {TICKERS} ---")
    total_new = 0
    
    # Loop through the TICKERS array above
    for ticker in TICKERS:
        print(f"Checking {ticker}...")
        try:
            # yfinance makes this super easy
            stock = yf.Ticker(ticker)
            news_list = stock.news
            
            for item in news_list:
                saved = save_news(ticker, item)
                if saved:
                    print(f"   [NEW] {item['title'][:50]}...")
                    total_new += 1
                    
        except Exception as e:
            print(f"   Error fetching {ticker}: {e}")

    print(f"\nâœ… Finished! Scraped {total_new} new articles.")

if __name__ == "__main__":
    init_db()
    fetch_market_news()